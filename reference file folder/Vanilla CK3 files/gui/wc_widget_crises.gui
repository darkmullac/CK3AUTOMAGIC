widget = {
	name = "wc_widget_crises"
    parentanchor = top|right
	layer = windows_layer
	# So it's not possible to click county behind the interface
	alwaystransparent = no
	filter_mouse = all

	#using = Window_Size_MainTab
	size = { 655 100% }

    visible = "[GetVariableSystem.HasValue( 'right_window_open', 'crises' )]"

    state = {
        name = _show
        using = Animation_FadeIn_Quick
        using = Sound_WindowShow_Standard
        using = Window_Position_MainTab

        on_start = "[GetVariableSystem.Clear( 'crises_tab' )]"
        on_start = "[GetVariableSystem.Set( 'crises_tab_top', 'world' )]"
    }

    state = {
        name = _hide
        using = Animation_FadeOut_Quick
        using = Sound_WindowHide_Standard
        using = Window_Position_MainTab_Hide

        on_start = "[GetVariableSystem.ClearIf( 'right_window_open', GetVariableSystem.HasValue( 'right_window_open', 'none' ) )]"
        on_start = "[GetVariableSystem.Clear( 'crises_tab' )]"
        on_start = "[GetVariableSystem.Clear( 'crises_tab_top' )]"
        on_start = "[GetScriptedGui('clear_crisis_gui').Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"
    }

    margin_widget = {
        size = { 100% 100% }
        margin = { -5 26 }
        margin_right = 20

        using = Window_Background

        vbox = {
            using = Window_Margins
            margin_bottom = 75
            widget_header_with_picture = {
                layoutpolicy_horizontal = expanding
                blockoverride "header_text"
                {
                    text = "CRISES_WINDOW_TITLE"
                }

                blockoverride "illustration_texture" {
                    texture = "gfx/interface/illustrations/window_headers/header_crises.dds"
                    alpha = 0.3
                    modify_texture = {
                        texture = "gfx/interface/component_masks/mask_culture_era_tab.dds"
                        blend_mode = alphamultiply
                    }
                }

                blockoverride "button_close"
                {
                    onclick = "[GetVariableSystem.Clear( 'right_window_open' )]"
                }
            }
            # TAB BUTTONS TOP
            hbox = {
                margin = { 10 0 }
                layoutpolicy_horizontal = expanding
                # World
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab_top', 'world' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab_top', 'world' )]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_WORLD"
                            default_format = "#low"
                        }
                    }
                }
                # Regional
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab_top', 'regional' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab_top', 'regional' )]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_REGIONAL"
                            default_format = "#low"
                        }
                    }
                }
            }
            # TAB BUTTONS REGIONAL
            hbox = {
                margin = { 10 0 }
                visible = "[GetVariableSystem.HasValue('crises_tab_top', 'regional' )]"
                layoutpolicy_horizontal = expanding
                # Horde
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab', 'horde' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab', 'horde' )]"

                    datacontext = "[GetScriptedGui('get_horde_crisis_title_gui')]"
                    onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_HORDE"
                            default_format = "#low"
                        }
                    }
                }
                # Thunder King
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab', 'thunder_king' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab', 'thunder_king' )]"

                    datacontext = "[GetScriptedGui('get_thunder_king_crisis_title_gui')]"
                    onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_THUNDER_KING"
                            default_format = "#low"
                        }
                    }
                }
            }

            # TAB BUTTONS WORLD
            hbox = {
                margin = { 10 0 }
                visible = "[GetVariableSystem.HasValue('crises_tab_top', 'world' )]"
                layoutpolicy_horizontal = expanding
                
                # Scourge
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab', 'scourge' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab', 'scourge' )]"

                    datacontext = "[GetScriptedGui('get_scourge_crisis_title_gui')]"
                    onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_SCOURGE"
                            default_format = "#low"
                        }
                    }
                }
                
                # Legion
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab', 'legion' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab', 'legion' )]"

                    datacontext = "[GetScriptedGui('get_legion_crisis_title_gui')]"
                    onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_LEGION"
                            default_format = "#low"
                        }
                    }
                }
                # Black Empire
                button_tab = {
                    layoutpolicy_horizontal = expanding

                    onclick = "[GetVariableSystem.Set( 'crises_tab', 'black_empire' )]"
                    down = "[GetVariableSystem.HasValue('crises_tab', 'black_empire' )]"

                    datacontext = "[GetScriptedGui('get_black_empire_crisis_title_gui')]"
                    onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"

                    hbox = {
                        text_single = {
                            layoutpolicy_horizontal = expanding
                            align = center
                            text = "TAB_BLACK_EMPIRE"
                            default_format = "#low"
                        }
                    }
                }
                # Player
                # button_tab = {
                #     layoutpolicy_horizontal = expanding

                #     onclick = "[GetVariableSystem.Set( 'crises_tab', 'player' )]"
                #     down = "[GetVariableSystem.HasValue('crises_tab', 'player' )]"

                #     datacontext = "[GetScriptedGui('get_player_crisis_title_gui')]"
                #     visible = "[GetScriptedGui('is_player_crisis_active_gui').IsValid( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                #     onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"

                #     hbox = {
                #         text_single = {
                #             layoutpolicy_horizontal = expanding
                #             align = center
                #             text = "TAB_OTHER"
                #             default_format = "#low"
                #         }
                #     }
                # }
            }
            vbox = {
                visible = "[Not(GetVariableSystem.Exists('crises_tab'))]"
                layoutpolicy_horizontal = expanding
                layoutpolicy_vertical = expanding

                hbox = {
                    text_single = {
                        layoutpolicy_horizontal = expanding
                        align = center
                        text = "TEXT_CLICK_CRISIS"
                        default_format = "#low"
                    }
                }
            }
            scrollbox = {
                layoutpolicy_horizontal = expanding
                layoutpolicy_vertical = expanding
                visible = "[GetVariableSystem.Exists('crises_tab')]"
                blockoverride "scrollbox_content"
                {
                    vbox = {
                        layoutpolicy_horizontal = expanding
                        layoutpolicy_vertical = expanding
                        spacing = 10

                        # CRISIS CHARACTER
                        vbox = {
                            visible = "[GetScriptedGui('is_crisis_active_gui').IsValid( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                            text_label_center = {
                                text = "[GetPlayer.MakeScope.Var('crisis_title').Title.Custom( 'GetCrisisCharacterGUI' )]"
                            }
                            portrait_head = {
                                datacontext = "[GetPlayer.MakeScope.Var('crisis_character').GetCharacter]"
                                blockoverride "portrait_button"
                                {
                                    using = tooltip_ne
                                }
                                blockoverride "glow_visible"
                                {
                                    visible = no
                                }
                            }
                        }

                        # DESC
                        vbox = {
                            layoutpolicy_horizontal = expanding

                            background = {
                                using = Background_Area_With_Header
                            }

                            ### NAME
                            hbox = {
                                ignoreinvisible = no
                                margin_top = 4
                                margin_bottom = 10

                                text_single = {
                                    text = "[GetPlayer.MakeScope.Var('crisis_title').Title.Custom( 'GetCrisisNameGUI' )]"
                                }
                            }

                            text_multi = {
                                text = "CRISIS_FEATURES"
                                autoresize = yes
                                max_width = 500
                                align = left|nobaseline
                                layoutpolicy_horizontal = expanding
                            }

                            text_multi = {
                                margin = { 0 10 }
                                text = "CRISIS_START_CONDITIONS"
                                autoresize = yes
                                max_width = 500
                                align = left
                                layoutpolicy_horizontal = expanding
                            }

                            text_multi = {
                                margin = { 0 10 }
                                text = "CRISIS_END_CONDITIONS"
                                autoresize = yes
                                max_width = 500
                                align = left
                                layoutpolicy_horizontal = expanding
                            }
                            
                            text_multi = {
                                margin = { 0 10 }
                                text = "[GetPlayer.MakeScope.Var('crisis_title').Title.Custom( 'GetCrisisDescGUI' )]"
                                autoresize = yes
                                max_width = 500
                                default_format = "#weak"
                                align = center
                            }
                        }

                        text_label_center = {
                            text = "CRISIS_STATUS"
                        }
                        vbox = {
                            visible = "[GetScriptedGui('is_crisis_active_gui').IsValid( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                            layoutpolicy_horizontal = expanding
                            layoutpolicy_vertical = expanding
                            spacing = 10
                            text_label_center = {
                                text = "CRISIS_STRENGTH"
                            }
                            vbox = {
                                layoutpolicy_horizontal = expanding
                                spacing = 10
                                margin_right = 20
                                margin_left = 20

                                text_label_center = {
                                    text = "COALITION_POWER"
                                }
                                widget = {
                                    size = { 100% 30 }
                                    layoutpolicy_horizontal = expanding

                                    progressbar_red = {
                                        size = { 100% 25 }
                                        value = "[FixedPointToProgressbarValue( GuiScope.SetRoot( GetPlayer.MakeScope.Var('crisis_character').GetCharacter.MakeScope ).ScriptValue('crisis_power_gui_value'))]"
                                        noprogresstexture = "gfx/interface/progressbars/progress_blue_bg.dds"
                                    }
                                    container = {
                                        alwaystransparent = yes

                                        icon = {
                                            parentanchor = top|right
                                            alwaystransparent = yes
                                            texture = "gfx/interface/window_factions/faction_progress_threshold.dds"
                                        }
                                    }
                                }
                            }

                            vbox = {
                                spacing = 10
                                layoutpolicy_vertical = expanding
                                layoutpolicy_horizontal = expanding
                                hbox = {
                                    spacing = 40
                                    button_standard = {
                                        size = { 200 50 }
                                        datacontext = "[GetScriptedGui('join_coalition_gui')]"
                                        visible = "[ScriptedGui.IsShown( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                                        enabled = "[ScriptedGui.IsValid( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                                        onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                                        tooltip = "[ScriptedGui.BuildTooltip( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"
                                        text = "join_coalition_interaction"
                                    }
                                    button_standard = {
                                        size = { 200 50 }
                                        datacontext = "[GetScriptedGui('leave_coalition_gui')]"
                                        visible = "[ScriptedGui.IsShown( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                                        enabled = "[ScriptedGui.IsValid( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                                        onclick = "[ScriptedGui.Execute( GuiScope.SetRoot( GetPlayer.MakeScope ).End )]"
                                        tooltip = "[ScriptedGui.BuildTooltip( GuiScope.SetRoot( GetPlayer.MakeScope ).End)]"
                                        text = "leave_coalition_interaction"
                                    }
                                }
                                button_checkbox_label = {
                                    layoutpolicy_vertical = expanding
                                    onclick = "[GetVariableSystem.Toggle('members_toggle')]"

                                    blockoverride "checkbox"
                                    {
                                        checked = "[GetVariableSystem.Exists('members_toggle')]"
                                    }

                                    blockoverride "text"
                                    {
                                        text = "TOGGLE_MEMBERS"
                                    }
                                }
                            }

                            # MEMBER LIST
                            vbox_character_row_item = {
                                visible = "[GetVariableSystem.Exists('members_toggle')]"
                                name = "crisis_members"
                                spacing = 5
                                layoutpolicy_horizontal = expanding

                                blockoverride "portrait_datamodel" {
                                    datamodel = "[GetPlayer.MakeScope.Var('crisis_character').GetCharacter.MakeScope.GetList('coalition_members')]"
                                }

                                blockoverride "gridbox" {
                                    fixedgridbox = {
                                        flipdirection = yes
                                        addcolumn = 85
                                        addrow = 90

                                        # Warcraft
                                        block "horizontal_slots"
                                        {
                                            datamodel_wrap = 7
                                        }

                                        block "gridbox_slots"
                                        {
                                            maxverticalslots = 1
                                        }

                                        block "portrait_datamodel" {
                                            datamodel = "[CharacterWindow.GetParents]"
                                        }

                                        item = {
                                            container = {
                                                datacontext = "[Scope.GetCharacter]"

                                                portrait_head_small = {
                                                    blockoverride "portrait_button"
                                                    {
                                                        using = tooltip_ne
                                                    }
                                                    blockoverride "glow_visible"
                                                    {
                                                        visible = no
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                blockoverride "gridbox_slots" {}
                                blockoverride "horizontal_slots" {
                                    datamodel_wrap = 6
                                }

                                blockoverride "header_text"
                                {
                                    text = "CRISIS_MEMBERS"
                                }

                                blockoverride "expand_button" {}
                            }
                        }
                    }
                }

                background = {
                    visible = "[GetVariableSystem.HasValue('crises_tab', 'scourge' )]"
                    texture = "gfx/interface/illustrations/hud/wc_scourge.dds"
                    using = Window_Crisis_Hud_Background
                }
                background = {
                    visible = "[GetVariableSystem.HasValue('crises_tab', 'legion' )]"
                    texture = "gfx/interface/illustrations/hud/wc_burning_legion.dds"
                    using = Window_Crisis_Hud_Background
                }
                background = {
                    visible = "[GetVariableSystem.HasValue('crises_tab', 'black_empire' )]"
                    texture = "gfx/interface/illustrations/hud/wc_black_empire.dds"
                    using = Window_Crisis_Hud_Background
                }
                background = {
                    visible = "[GetVariableSystem.HasValue('crises_tab', 'horde' )]"
                    texture = "gfx/interface/illustrations/hud/wc_horde.dds"
                    using = Window_Crisis_Hud_Background
                }
                background = {
                    visible = "[GetVariableSystem.HasValue('crises_tab', 'thunder_king' )]"
                    texture = "gfx/interface/illustrations/hud/wc_thunder_king.dds"
                    using = Window_Crisis_Hud_Background
                }
            }
        }
    }

}